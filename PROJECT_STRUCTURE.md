# é¡¹ç›®ç»“æ„è¯´æ˜

## ğŸ“ ç›®å½•æ ‘

```
/Users/lhy/CLionProjects/still_music_when_back/
â”‚
â”œâ”€â”€ ğŸ“„ README.md                           # é¡¹ç›®ä¸»æ–‡æ¡£
â”œâ”€â”€ ğŸ“„ QUICKSTART.md                       # å¿«é€Ÿå¼€å§‹æŒ‡å—
â”œâ”€â”€ ğŸ“„ SETUP_GUIDE.md                      # è¯¦ç»†è®¾ç½®æ•™ç¨‹
â”œâ”€â”€ ğŸ“„ PROJECT_STRUCTURE.md                # æœ¬æ–‡ä»¶ - é¡¹ç›®ç»“æ„è¯´æ˜
â”œâ”€â”€ ğŸ“„ .gitignore                          # Git å¿½ç•¥æ–‡ä»¶é…ç½®
â”‚
â”œâ”€â”€ ğŸ“‚ SourceFiles/                        # æºä»£ç æ–‡ä»¶ï¼ˆå¾…æ·»åŠ åˆ° Xcodeï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“‚ App/                           # åº”ç”¨ç¨‹åºå…¥å£
â”‚   â”‚   â””â”€â”€ ğŸ“„ StillMusicWhenBackApp.swift
â”‚   â”‚       - åº”ç”¨ä¸»å…¥å£
â”‚   â”‚       - AppDelegate ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”‚       - åˆå§‹åŒ–æ‰€æœ‰æ ¸å¿ƒæœåŠ¡
â”‚   â”‚       - æƒé™è¯·æ±‚å’Œé”™è¯¯å¤„ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“‚ Core/                          # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ AudioMonitor/             # éŸ³é¢‘ç›‘æ§æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ AudioMonitorService.swift
â”‚   â”‚   â”‚   â”‚   - ä½¿ç”¨ ScreenCaptureKit æ•è·ç³»ç»ŸéŸ³é¢‘
â”‚   â”‚   â”‚   â”‚   - éŸ³é¢‘æµç®¡ç†
â”‚   â”‚   â”‚   â”‚   - éŸ³é¢‘ç¼“å†²åŒºå¤„ç†
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ AudioLevelDetector.swift
â”‚   â”‚   â”‚       - RMS/Peak éŸ³é‡è®¡ç®—
â”‚   â”‚   â”‚       - æ™ºèƒ½é˜ˆå€¼ç®—æ³•
â”‚   â”‚   â”‚       - ç¯å¢ƒå™ªéŸ³åŸºçº¿å­¦ä¹ 
â”‚   â”‚   â”‚       - æ»‘åŠ¨çª—å£å¹³æ»‘
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ MusicController/          # éŸ³ä¹æ§åˆ¶æ¨¡å—
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ NeteaseMusicController.swift
â”‚   â”‚   â”‚       - AppleScript æ§åˆ¶ç½‘æ˜“äº‘éŸ³ä¹
â”‚   â”‚   â”‚       - æ’­æ”¾çŠ¶æ€æ£€æµ‹ï¼ˆé€šè¿‡èœå•é¡¹ï¼‰
â”‚   â”‚   â”‚       - æ’­æ”¾/æš‚åœæ“ä½œ
â”‚   â”‚   â”‚       - å¤‡ç”¨æ–¹æ¡ˆï¼šé”®ç›˜å¿«æ·é”®æ¨¡æ‹Ÿ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ StateManager/             # çŠ¶æ€ç®¡ç†æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ MonitorState.swift
â”‚   â”‚   â”‚   â”‚   - çŠ¶æ€æšä¸¾å®šä¹‰
â”‚   â”‚   â”‚   â”‚   - çŠ¶æ€æè¿°å’Œå›¾æ ‡
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ StateTransitionEngine.swift
â”‚   â”‚   â”‚       - çŠ¶æ€æœºæ ¸å¿ƒå¼•æ“
â”‚   â”‚   â”‚       - çŠ¶æ€è½¬æ¢é€»è¾‘
â”‚   â”‚   â”‚       - åè°ƒéŸ³é¢‘æ£€æµ‹å’ŒéŸ³ä¹æ§åˆ¶
â”‚   â”‚   â”‚       - ç®¡ç†å»¶è¿Ÿè®¡æ—¶å™¨
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ğŸ“‚ Timer/                    # è®¡æ—¶å™¨æ¨¡å—
â”‚   â”‚       â””â”€â”€ ğŸ“„ DelayTimer.swift
â”‚   â”‚           - ç²¾ç¡®çš„ 3 ç§’å»¶è¿Ÿè®¡æ—¶
â”‚   â”‚           - æ”¯æŒå¯åŠ¨/åœæ­¢/é‡ç½®
â”‚   â”‚           - çº¿ç¨‹å®‰å…¨è®¾è®¡
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“‚ UI/                           # ç”¨æˆ·ç•Œé¢
â”‚   â”‚   â””â”€â”€ ğŸ“‚ MenuBar/
â”‚   â”‚       â””â”€â”€ ğŸ“„ MenuBarController.swift
â”‚   â”‚           - NSStatusBar ç®¡ç†
â”‚   â”‚           - èœå•æ å›¾æ ‡æ˜¾ç¤º
â”‚   â”‚           - å¼¹å‡ºèœå•åˆ›å»º
â”‚   â”‚           - çŠ¶æ€å˜åŒ– UI æ›´æ–°
â”‚   â”‚           - ç”¨æˆ·äº¤äº’å¤„ç†
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“‚ Utilities/                    # å·¥å…·ç±»
â”‚       â”œâ”€â”€ ğŸ“„ PermissionManager.swift
â”‚       â”‚   - å±å¹•å½•åˆ¶æƒé™æ£€æŸ¥
â”‚       â”‚   - è¾…åŠ©åŠŸèƒ½æƒé™æ£€æŸ¥
â”‚       â”‚   - æƒé™è¯·æ±‚å’Œå¼•å¯¼
â”‚       â”‚   - æ‰“å¼€ç³»ç»Ÿè®¾ç½®
â”‚       â”‚
â”‚       â””â”€â”€ ğŸ“„ LaunchAtLoginManager.swift
â”‚           - ServiceManagement æ¡†æ¶å°è£…
â”‚           - å¼€æœºè‡ªå¯åŠ¨æ³¨å†Œ/æ³¨é”€
â”‚           - çŠ¶æ€æŸ¥è¯¢
â”‚
â”œâ”€â”€ ğŸ“‚ .git/                              # Git ç‰ˆæœ¬æ§åˆ¶ï¼ˆéšè—ï¼‰
â”‚
â””â”€â”€ ğŸ“‚ StillMusicWhenBack/                # Xcode é¡¹ç›®ç›®å½•ï¼ˆéœ€è¦åˆ›å»ºï¼‰
    â”œâ”€â”€ StillMusicWhenBack.xcodeproj/     # Xcode é¡¹ç›®æ–‡ä»¶
    â””â”€â”€ StillMusicWhenBack/               # Xcode æºä»£ç ç›®å½•
        â””â”€â”€ ï¼ˆå°† SourceFiles/ ä¸­çš„æ–‡ä»¶æ·»åŠ åˆ°è¿™é‡Œï¼‰
```

---

## ğŸ”‘ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1ï¸âƒ£ éŸ³é¢‘ç›‘æ§æµç¨‹

```
ScreenCaptureKit (ç³»ç»ŸAPI)
    â†“
AudioMonitorService (æ•è·éŸ³é¢‘)
    â†“
processAudioBuffer (å¤„ç†ç¼“å†²åŒº)
    â†“
AudioLevelDetector (åˆ†æéŸ³é‡)
    â†“
è®¡ç®— RMS + Peak â†’ ä¸é˜ˆå€¼æ¯”è¾ƒ
    â†“
onSignificantSoundDetected(hasSound) â†’ å›è°ƒ
    â†“
StateTransitionEngine (çŠ¶æ€æœºå¤„ç†)
```

### 2ï¸âƒ£ ç½‘æ˜“äº‘æ§åˆ¶æµç¨‹

```
NeteaseMusicController
    â†“
isPlaying() æ£€æµ‹å½“å‰çŠ¶æ€
    â†“
é€šè¿‡ AppleScript è¯»å–èœå•é¡¹
    â†“
"æš‚åœ" = æ­£åœ¨æ’­æ”¾
"æ’­æ”¾" = å·²æš‚åœ
    â†“
pause() / play() æ‰§è¡Œæ§åˆ¶
    â†“
é€šè¿‡ AppleScript ç‚¹å‡»èœå•é¡¹
```

### 3ï¸âƒ£ çŠ¶æ€æœºè½¬æ¢æµç¨‹

```
monitoring (ç›‘æ§ä¸­)
    â†“ (æ£€æµ‹åˆ°å£°éŸ³)
detectingOtherSound (è®¡æ—¶ 3ç§’)
    â†“ (3ç§’åˆ°æœŸ + ç½‘æ˜“äº‘åœ¨æ’­æ”¾)
musicPaused (å·²æš‚åœéŸ³ä¹)
    â†“ (å£°éŸ³åœæ­¢)
waitingResume (è®¡æ—¶ 3ç§’)
    â†“ (3ç§’åˆ°æœŸ)
monitoring (æ¢å¤ç›‘æ§)
```

---

## ğŸ“Š æ–‡ä»¶ä¾èµ–å…³ç³»

```
StillMusicWhenBackApp.swift (å…¥å£)
    â”‚
    â”œâ”€â†’ PermissionManager.swift (æƒé™æ£€æŸ¥)
    â”‚
    â”œâ”€â†’ AudioMonitorService.swift
    â”‚   â””â”€â†’ AudioLevelDetector.swift
    â”‚
    â”œâ”€â†’ NeteaseMusicController.swift
    â”‚
    â”œâ”€â†’ StateTransitionEngine.swift
    â”‚   â”œâ”€â†’ MonitorState.swift
    â”‚   â”œâ”€â†’ DelayTimer.swift
    â”‚   â”œâ”€â†’ AudioMonitorService (æ¥æ”¶éŸ³é¢‘å›è°ƒ)
    â”‚   â””â”€â†’ NeteaseMusicController (æ§åˆ¶æ’­æ”¾)
    â”‚
    â”œâ”€â†’ MenuBarController.swift
    â”‚   â””â”€â†’ StateTransitionEngine (æ¥æ”¶çŠ¶æ€å˜åŒ–)
    â”‚
    â””â”€â†’ LaunchAtLoginManager.swift (å¼€æœºè‡ªå¯åŠ¨)
```

---

## ğŸ”§ Xcode é¡¹ç›®ç»“æ„ï¼ˆåˆ›å»ºåï¼‰

åˆ›å»º Xcode é¡¹ç›®åï¼Œç›®å½•ç»“æ„å°†å˜ä¸ºï¼š

```
/Users/lhy/CLionProjects/still_music_when_back/
â”œâ”€â”€ StillMusicWhenBack.xcodeproj/
â”‚   â””â”€â”€ project.pbxproj
â”‚
â”œâ”€â”€ StillMusicWhenBack/
â”‚   â”œâ”€â”€ App/
â”‚   â”‚   â””â”€â”€ StillMusicWhenBackApp.swift
â”‚   â”œâ”€â”€ Core/
â”‚   â”‚   â”œâ”€â”€ AudioMonitor/
â”‚   â”‚   â”œâ”€â”€ MusicController/
â”‚   â”‚   â”œâ”€â”€ StateManager/
â”‚   â”‚   â””â”€â”€ Timer/
â”‚   â”œâ”€â”€ UI/
â”‚   â”‚   â””â”€â”€ MenuBar/
â”‚   â”œâ”€â”€ Utilities/
â”‚   â”œâ”€â”€ Resources/
â”‚   â”‚   â””â”€â”€ Assets.xcassets/
â”‚   â””â”€â”€ Info.plist
â”‚
â””â”€â”€ SourceFiles/ (å¤‡ä»½ï¼Œå¯ä»¥åˆ é™¤)
```

---

## ğŸ“ ä»£ç ç»Ÿè®¡

| æ¨¡å— | æ–‡ä»¶ | ä»£ç è¡Œæ•°ï¼ˆä¼°ç®—ï¼‰ |
|------|------|-----------------|
| App | 1 | ~150 è¡Œ |
| AudioMonitor | 2 | ~300 è¡Œ |
| MusicController | 1 | ~200 è¡Œ |
| StateManager | 2 | ~200 è¡Œ |
| Timer | 1 | ~80 è¡Œ |
| UI | 1 | ~150 è¡Œ |
| Utilities | 2 | ~150 è¡Œ |
| **æ€»è®¡** | **10** | **~1230 è¡Œ** |

---

## ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ

1. âœ… å·²å®Œæˆï¼šæ‰€æœ‰æºä»£ç æ–‡ä»¶å·²åˆ›å»º
2. â³ å¾…å®Œæˆï¼šåœ¨ Xcode ä¸­åˆ›å»ºé¡¹ç›®
3. â³ å¾…å®Œæˆï¼šæ·»åŠ æºæ–‡ä»¶åˆ° Xcode
4. â³ å¾…å®Œæˆï¼šæ„å»ºå’Œæµ‹è¯•
5. â³ å¾…å®Œæˆï¼šå‘å¸ƒå’Œåˆ†å‘

è¯·å‚è€ƒ [QUICKSTART.md](QUICKSTART.md) å®Œæˆå‰©ä½™æ­¥éª¤ï¼
